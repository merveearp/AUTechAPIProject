@*
    GeminiChat ViewComponent
*@

<!-- AI ROBOT (SABİT – SAĞ ALT) -->
<div id="ai-robot" title="Gemini AI">🤖</div>

<!-- AI CHAT PENCERESİ -->
<div id="ai-chat">
    <div class="ai-chat-header">
        🤖💬 Gemini AI
        <span id="ai-chat-close">✕</span>
    </div>

    <div class="ai-chat-body" id="ai-chat-body">
        <div class="ai-message ai">
            Merhaba 👋 Size nasıl yardımcı olabilirim?
        </div>
    </div>

    <div class="ai-chat-footer">
        <input type="text" id="ai-input" placeholder="Mesajınızı yazın..." />
        <button id="ai-send">Gönder</button>
    </div>
</div>

<style>
    /* CHAT */
    #ai-chat {
        position: fixed;
        bottom: 110px;
        right: 25px;
        width: 320px;
        height: 420px;
        background: #ffffff;
        border-radius: 14px;
        box-shadow: 0 20px 50px rgba(0,0,0,.35);
        display: none;
        flex-direction: column;
        z-index: 99999;
        overflow: hidden;
    }

    .ai-chat-header {
        background: linear-gradient(135deg, #0d6efd, #20c997);
        color: #fff;
        padding: 12px;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #ai-chat-close {
        cursor: pointer;
    }

    .ai-chat-body {
        padding: 12px;
        flex: 1;
        overflow-y: auto;
        background: #f8f9fa;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .ai-message {
        max-width: 80%;
        padding: 8px 10px;
        border-radius: 10px;
        font-size: 13px;
    }

        .ai-message.ai {
            background: #dbeafe;
            align-self: flex-start;
        }

        .ai-message.user {
            background: #0d6efd;
            color: #fff;
            align-self: flex-end;
        }

    .ai-chat-footer {
        display: flex;
        border-top: 1px solid #eee;
    }

        .ai-chat-footer input {
            flex: 1;
            border: none;
            padding: 10px;
            font-size: 13px;
            outline: none;
        }

        .ai-chat-footer button {
            border: none;
            background: #0d6efd;
            color: #fff;
            padding: 0 16px;
            cursor: pointer;
        }

    /* ROBOT */
    #ai-robot {
        position: fixed;
        bottom: 30px;
        right: 25px;
        width: 65px;
        height: 65px;
        border-radius: 50%;
        background: linear-gradient(135deg, #0d6efd, #20c997);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 30px;
        color: #fff;
        cursor: pointer;
        animation: aiFloat 3s ease-in-out infinite;
        z-index: 99999;
        box-shadow: 0 12px 35px rgba(0,0,0,.35);
    }

        aiFloat {
        0%, 100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-10px);
        }
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function () {

        const aiRobot = document.getElementById("ai-robot");
        const aiChat = document.getElementById("ai-chat");
        const closeBtn = document.getElementById("ai-chat-close");

        const sendBtn = document.getElementById("ai-send");
        const input = document.getElementById("ai-input");
        const chatBody = document.getElementById("ai-chat-body");

        
        if (aiRobot && aiChat) {
            aiRobot.addEventListener("click", () => {
                aiChat.style.display =
                    aiChat.style.display === "flex" ? "none" : "flex";
            });
        }

        if (closeBtn) {
            closeBtn.addEventListener("click", () => {
                aiChat.style.display = "none";
            });
        }

        if (!sendBtn || !input || !chatBody) return;

        function addUserMessage(message) {
            const div = document.createElement("div");
            div.className = "ai-message user";
            div.innerText = message;
            chatBody.appendChild(div);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function addAiMessage(message) {
            const div = document.createElement("div");
            div.className = "ai-message ai";
            div.innerText = message;
            chatBody.appendChild(div);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function addYesNoButtons() {
            const container = document.createElement("div");
            container.className = "ai-message ai";

            container.innerHTML = `
                <div style="margin-top:8px;">
                    <button id="ai-yes" style="margin-right:6px;">Evet</button>
                    <button id="ai-no">Hayır</button>
                </div>
            `;

            chatBody.appendChild(container);
            chatBody.scrollTop = chatBody.scrollHeight;

            document.getElementById("ai-yes").onclick = () => {
                window.location.hash = "contact";
                aiChat.style.display = "none";
            };

            document.getElementById("ai-no").onclick = () => {
                addAiMessage("Tamam 👍 Başka nasıl yardımcı olabilirim?");
                container.remove();
            };
        }

        sendBtn.addEventListener("click", sendMessage);

        input.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
                sendMessage();
            }
        });

        function sendMessage() {
            const message = input.value.trim();
            if (message === "") return;

            addUserMessage(message);
            input.value = "";

            addAiMessage("⏳ Gemini düşünüyor...");

            fetch("/Gemini/Gemini", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: "prompt=" + encodeURIComponent(message)
            })
            .then(res => res.json())
            .then(data => {
                const thinking = chatBody.querySelector(".ai-message.ai:last-child");
                if (thinking) thinking.remove();

                addAiMessage(data.answer);

                
                if (data.answer.toLowerCase().includes("mesaj bırakmak ister misiniz")) {
                    addYesNoButtons();
                }
            })
            .catch(err => {
                const thinking = chatBody.querySelector(".ai-message.ai:last-child");
                if (thinking) thinking.remove();

                addAiMessage("⚠️ Bir hata oluştu.");
                console.error(err);
            });
        }
    });
</script>
